<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Pybonacci">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Probando numba: compilador para Python basado en LLVM | Pybonacci</title>

	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="alternate" type="application/atom+xml" title="Pybonacci blog atom feed" href="/feeds/all.atom.xml" />
        <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="/theme/css/fontello.css"/>
        <style>.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #60a0b0; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #007020; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #007020 } /* Comment.Preproc */
.highlight .c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.highlight .cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #007020 } /* Keyword.Pseudo */
.highlight .kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #902000 } /* Keyword.Type */
.highlight .m { color: #40a070 } /* Literal.Number */
.highlight .s { color: #4070a0 } /* Literal.String */
.highlight .na { color: #4070a0 } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.highlight .no { color: #60add5 } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #d55537; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #007020 } /* Name.Exception */
.highlight .nf { color: #06287e } /* Name.Function */
.highlight .nl { color: #002070; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #062873; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #bb60d5 } /* Name.Variable */
.highlight .ow { color: #007020; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #40a070 } /* Literal.Number.Float */
.highlight .mh { color: #40a070 } /* Literal.Number.Hex */
.highlight .mi { color: #40a070 } /* Literal.Number.Integer */
.highlight .mo { color: #40a070 } /* Literal.Number.Oct */
.highlight .sb { color: #4070a0 } /* Literal.String.Backtick */
.highlight .sc { color: #4070a0 } /* Literal.String.Char */
.highlight .sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #4070a0 } /* Literal.String.Double */
.highlight .se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #4070a0 } /* Literal.String.Heredoc */
.highlight .si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.highlight .sx { color: #c65d09 } /* Literal.String.Other */
.highlight .sr { color: #235388 } /* Literal.String.Regex */
.highlight .s1 { color: #4070a0 } /* Literal.String.Single */
.highlight .ss { color: #517918 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #bb60d5 } /* Name.Variable.Class */
.highlight .vg { color: #bb60d5 } /* Name.Variable.Global */
.highlight .vi { color: #bb60d5 } /* Name.Variable.Instance */
.highlight .il { color: #40a070 } /* Literal.Number.Integer.Long */</style>
        <style>.description-author {
  font-size: 0.8em;
  color: #333;
}
.img-author {
  max-height: 10em;
  max-width: 10em;
}
img[src$="centerme"] {
  display: block;
  margin: 0 auto;
}
body {
  margin: 0;
  padding: 0;
  font: 15px 'Source Sans Pro', sans-serif;
  line-height: 1.6em;
  color: #222222;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
}
a {
  color: #007ee5;
  text-decoration: none;
}
a:hover {
  color: #007ee5;
  text-decoration: none;
}
header.main-header {
  background: none repeat scroll 0% 0% #205F29;
  margin-bottom: 0px;
}
header.main-header a {
  color: #fff;
}
header.main-header .container {
  max-width: 1000px;
}
header.main-header .container nav a:hover {
  background-color: #5C881C;
}
header.navbar-default {
  border-bottom: none;
  background-color: #EFEFEF;
}
article {
  margin: 0;
}
article header.about {
  margin-bottom: 0px;
  padding-bottom: 0px;
}
article header {
  padding-bottom: 20px;
}
article header h1 {
  margin-bottom: 2px;
  font-weight: 700;
  color: #000;
}
article header time {
  color: #9E9E9E;
  float: right;
}
article header time.left {
  color: #9E9E9E;
  float: left;
}
article div.social-links ul {
  padding: 0px;
}
article div.social-links li {
  display: inline;
  font-size: 20px;
}
article div.social-links li a {
  color: #000;
  padding: 10px;
}
article div.social-links li a:hover {
  color: #666;
  text-decoration: none;
}
article p {
  font-size: 2em;
  margin-bottom: 20px;
  line-height: 1.6em;
  text-align: justify;
}
article p.note {
  background: #f5f5f5;
  border: 1px solid #ddd;
  padding: 0.533em 0.733em;
}
article p.update {
  background-color: #FEEFB3;
  border: 1px solid #e6e68a;
  padding: 0.533em 0.733em;
}
article p.alert {
  background-color: #ffe2e2;
  border: 1px solid #ffb2b2;
  padding: 0.533em 0.733em;
}
article ul,
article ol {
  margin-top: 0px;
  margin-bottom: 25px;
}
article li {
  font-size: 16px;
  line-height: 1.6em;
}
article a:hover {
  text-decoration: underline;
}
article blockquote {
  border-left: 2px solid #c7c7cc;
  color: #666;
  margin: 30px 0;
  padding: 0 0 0 25px;
}
article img {
  max-width: 100%;
}
article code {
  color: #333;
  background-color: #EEE;
  border-radius: 0;
  font-size: 1.1em;
}
article .meta {
  margin-top: 35px;
}
article .meta a:hover {
  text-decoration: none;
}
article .meta div {
  display: block;
}
article .meta address:before,
article .meta time:before,
article .meta a.tag:before {
  font-family: 'fontello';
  margin-right: 6px;
}
article .meta address.author {
  float: left;
}
article .meta address:before {
  content: '\e819';
}
article .meta time:before {
  content: '\f133';
}
article .meta div.tags {
  clear: both;
}
article .meta a.tag {
  margin: 0 10px 10px 0;
  padding: 1px 12px;
  display: inline-block;
  font-size: 14px;
  color: rgba(0, 0, 0, 0.8);
  background: rgba(0, 0, 0, 0.05);
}
article .meta a.tag:before {
  content: '\e821';
}
article .meta a.tag:hover {
  background: rgba(0, 0, 0, 0.15);
}
article .meta a.read_more,
article .meta a.comments_btn {
  font-size: 14px;
  font-weight: 800;
  padding: 10px 20px;
  color: #007aa3;
  background: #FFF;
  border: 1px solid #007aa3;
}
article .meta a.read_more:hover,
article .meta a.comments_btn:hover {
  color: #FFF;
  background: #007aa3;
}
article .meta:after {
  content: "";
  display: table;
  clear: both;
}
.index {
  max-width: 700px;
}
.index article header h2 {
  font-size: 36px;
  margin-bottom: 2px;
  font-weight: 700;
}
.index article header h2 a {
  color: #333;
}
.index article header h2 a:hover {
  color: #007ee5;
  text-decoration: none;
}
.index .separator {
  padding: 40px 0 0 0;
  margin: 0 0 40px 0;
  height: 10px;
  border-bottom: solid 1px #CCC;
}
.index .pagination {
  display: block;
  margin-bottom: 100px;
}
.index .pagination .left {
  text-align: right;
}
.index .pagination .right {
  text-align: left;
}
.index .pagination a {
  display: inline-block;
  border: 2px solid #5C881C;
  margin: 0 5px;
  padding: 8px 20px;
  font-weight: bold;
  color: #5C881C;
}
.index .pagination a:hover {
  color: #FFF;
  background: #5C881C;
}
.post {
  max-width: 80%;
}
.post h1 {
  font-size: 42px;
}
.post h2:before {
  content: "# ";
  font-weight: bold;
  color: #DDD;
}
.post h3:before {
  content: "## ";
  font-weight: bold;
  color: #DDD;
}
.post h4:before {
  content: "### ";
  font-weight: bold;
  color: #DDD;
}
.post p {
  font-size: 2em;
}
.post li {
  font-size: 2em;
}
.list {
  max-width: 700px;
}
.list ul.double-list {
  margin: 0 auto 60px;
  padding: 0;
  list-style-type: none;
}
.list ul.double-list li {
  padding: 5px 0;
}
.list ul.double-list li h2 {
  font-size: 2em;
  display: inline;
  font-weight: normal;
}
.list ul.double-list li span {
  font-family: sans-serif;
  text-transform: uppercase;
  text-align: right;
  float: right;
  padding-top: 3px;
  font-size: 12px;
  color: #999;
}
.full-width-content {
  padding-top: 10px;
  padding-left: 0px;
  padding-right: 0px;
  margin-left: -20px;
  margin-right: -20px;
}
.col-xs-1,
.col-sm-1,
.col-md-1,
.col-lg-1,
.col-xs-2,
.col-sm-2,
.col-md-2,
.col-lg-2,
.col-xs-3,
.col-sm-3,
.col-md-3,
.col-lg-3,
.col-xs-4,
.col-sm-4,
.col-md-4,
.col-lg-4,
.col-xs-5,
.col-sm-5,
.col-md-5,
.col-lg-5,
.col-xs-6,
.col-sm-6,
.col-md-6,
.col-lg-6,
.col-xs-7,
.col-sm-7,
.col-md-7,
.col-lg-7,
.col-xs-8,
.col-sm-8,
.col-md-8,
.col-lg-8,
.col-xs-9,
.col-sm-9,
.col-md-9,
.col-lg-9,
.col-xs-10,
.col-sm-10,
.col-md-10,
.col-lg-10,
.col-xs-11,
.col-sm-11,
.col-md-11,
.col-lg-11,
.col-xs-12,
.col-sm-12,
.col-md-12,
.col-lg-12 {
  padding-right: 0px;
  padding-left: 0px;
}
.disclaimer {
  text-align: center;
  background-color: #EFEFEF;
  border-bottom: none;
  margin-top: 6em;
}
pre {
  font-size: 1.2em;
}</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

       <script src="https://comments.pybonacci.org/assets/js/commento.js" data-div="#commento"></script>

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        });
        MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
            for(i=0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script>


        </script>

    </head>

    <body>
        <header class="navbar navbar-default bs-docs-nav">
            <div class="container-fluid">
                <div class="navbar-header">
		  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#theNavbar">
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span> 
		  </button>
                  <a class="navbar-brand" href="/" title="Home" class="title">Pybonacci</a><!-- — Python y Ciencia-->
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation" id="theNavbar">
		    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/acerca-de-pybonacci.html" title="About">Acerca de</a></li>
                            <li><a href="/archives.html" title="Archive">Archivos</a></li>
                            <li><a class="nodec icon-rss" href="/feeds/all.atom.xml" title="pybonacci.github.io RSS feed" rel="me"></a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div id="wrap">
<div class="container post">
    <article>
        <header>
            <h1>Probando numba: compilador para Python basado en LLVM</h1>
            <div class="meta">
                <time datetime="article.date.isoformat()" pubdate>mar 21 agosto 2012</time>
                <address class="vcard author">Por
                    <a class="url fn" href="http://pybonacci.github.io/author/juan-luis-cano.html">Juan Luis Cano</a>
                </address>
            </div>
        </header>

        <div class="article_content">
            <h2>Introducción</h2>
<p>Hace unos días <a href="http://continuum.io/our-team.html#travis">Travis E. Oliphant</a>, creador de NumPy e importante contribuidor de SciPy entre otras muchas cosas, anunciaba <a href="https://twitter.com/teoliphant/status/235789560678858752">en su Twitter</a> y <a href="http://technicaldiscovery.blogspot.com.es/2012/08/numba-and-llvmpy.html">en su blog</a> la liberación de <a href="http://numba.pydata.org/">numba 0.1</a>, un proyecto que <strong>pretende ser el mejor compilador orientado a arrays</strong> del mundo, como puedes ver en la presentación que dio en la conferencia SciPy 2012 celebrada en Austin, Texas (<a href="http://youtu.be/WYi1cymszqY">vídeo</a> y <a href="http://www.slideshare.net/teoliphant/numba">diapositivas</a>).</p>
<blockquote class="twitter-tweet" width="550">
  <p>
    Just released Numba 0.1. Thanks Jon Riehl from Resilient Science for all the hard work. Binaries to follow. <a href="http://t.co/o80rn7By">http://t.co/o80rn7By</a>
  </p>

  <p>
    &mdash; Travis Oliphant (@teoliphant) <a href="https://twitter.com/teoliphant/statuses/235789560678858752">August 15, 2012</a>
  </p>
</blockquote>

<p>Aunque el proyecto está en una fase bastante precaria todavía y hay unos cuantos fallos pendientes de solucionar todavía, hemos hecho algunas pruebas y los resultados son impresionantes. Vamos a hablar un poco de numba y a explicar cómo puedes probarlo tú mismo.</p>
<!--more-->

<h2>Motivación</h2>
<p>Ya hemos hablado en dos ocasiones sobre la lentitud de Python y hemos dado algunas soluciones para evitarla, bien <a href="http://pybonacci.org/2012/05/01/python-es-lento/" title="Python es lento">utilizando bibliotecas que aceleren el código escrito en Python</a> o <a href="http://pybonacci.org/2012/06/24/revisitando-python-es-lento-pequenos-trucos/" title="Revisitando ‘python es lento’: pequeños trucos">teniendo en cuenta pequeños trucos</a> a la hora de escribir nuestros programas. En la charla que hemos mencionado antes, Oliphant menciona algunas de ellas, concretamente <strong>PyPy</strong> y <strong>Cython</strong> (David ya habló de las dos en su artículo). Estas dos soluciones tienen sus inconvenientes:</p>
<ul>
<li>PyPy <strong>no</strong> funciona con CPython, la implementación principal de Python. Esto significa que las extensiones escritas para Python no se pueden utilizar fácilmente en PyPy, y hay una que es fundamental para nosotros: NumPy.</li>
<li>Cython supone otra sintaxis que hay que aprender, y si se quiere optimizar mucho se va perdiendo la legibilidad de Python poco a poco.</li>
</ul>
<p>Con <strong>numba</strong>, tenemos una forma de acelerar código escrito en Python que:</p>
<ul>
<li>Está especialmente pensada y optimizada para <strong>códigos numéricos</strong>,</li>
<li>Entiende los tipos de <strong>NumPy</strong>, su API y sus estructuras de datos,</li>
<li><strong>No requiere aprender una nueva sintaxis</strong>, conservando así la belleza y legibilidad de Python, y</li>
<li>Produce programas con <strong>velocidades cercanas a las de C</strong>.</li>
</ul>
<p>¿Y cómo se consigue esto? numba genera código <a href="http://es.wikipedia.org/wiki/LLVM">LLVM</a> y crea un wrapper para llamarlo desde Python. De esta forma conseguimos un compilador JIT para Python, en la línea de otros proyectos como el abandonado Unladen Swallow.</p>
<p>Interesante, ¿no? Si quieres probar numba en tu propio ordenador, sigue leyendo.</p>
<h2>Instalación</h2>
<p>Para no complicarnos la vida, vamos a dar las instrucciones de instalación para Linux. Parece ser que <del datetime="2012-08-21T19:29:56+00:00">Windows no está soportado</del> <ins datetime="2012-08-21T19:31:50+00:00">en Windows hay un par de problemas (<a href="https://github.com/numba/numba/issues/27">#27</a>, <a href="https://github.com/numba/numba/issues/28">#28</a>)</ins>, y en cuanto a Mac OS X no tengo ni idea.</p>
<p>En la web de numba tienes los <a href="http://numba.pydata.org/#quickstart">pasos que hay que seguir</a> para instalarlo. Los requisitos son:</p>
<ol>
<li><a href="http://www.llvm.org/">llvm 3.1</a> compilado con las opciones <code>--enable-pic</code> y <code>--disable-libffi</code>. La segunda opción soluciona un bug que afecta a algunos, incluido yo.</li>
<li><a href="https://github.com/llvmpy/llvmpy">llvm-py</a>. Con la versión del repositorio ha funcionado.</li>
</ol>
<p>En primer lugar, descarga y extrae las fuentes de llvm 3.1 y ejecuta los siguientes comandos para compilar la biblioteca:</p>
<div class="highlight"><pre><span></span>$ ./configure --enable-pic --disable-libffi
$ make
$ make install
</pre></div>


<p>A continuación, clona el repositorio de llvm-py e instala la biblioteca:</p>
<div class="highlight"><pre><span></span>$ git clone https://github.com/llvmpy/llvmpy.git
$ <span class="nb">cd</span> llvmpy
$ python setup.py install
</pre></div>


<p>Por último, ya puedes instalar numba directamente del repositorio también:</p>
<div class="highlight"><pre><span></span>$ git clone https://github.com/numba/numba.git
$ <span class="nb">cd</span> numba
$ git submodule init
$ git submodule update
$ python setup.py install
</pre></div>


<p>En principio estas instrucciones funcionan en el caso más general, pero si tienes algún problema concreto durante el proceso o más adelante probando los ejemplos, dínoslo en los comentarios.</p>
<h2>Ejemplos</h2>
<p>Las fuentes de numba contienen algunos ejemplos y benchmarks que puedes probar para evaluar las capacidades de la biblioteca. Además, <a href="http://twitter.com/awiltsch">Alex Wiltschko</a> ha estado haciendo pruebas e informando de algunos fallos y nos ha dejado que hagamos uso de los programas que ha escrito (<em>thanks Alex!</em>).</p>
<p>Las capacidades de numba se aprecian mejor si se aplican con programas con muchos bucles anidados, como algoritmos de procesamiento de imágenes. De todos modos, para empezar vamos a probar un ejemplo sencillo, que puedes encontrar en <a href="https://github.com/numba/numba/blob/master/examples/sum.py">https://github.com/numba/numba/blob/master/examples/sum.py</a>.</p>
<p><strong>Nota</strong>: En el momento de escribir el artículo se imprime todo el código LLVM creado por numba cuando se aplica a una función. Para evitar este comportamiento, puedes ejecutar los ejemplos añadiendo la opción <code>-O</code>, que activa optimizaciones básicas.</p>
<p>El código del ejemplo es el siguiente:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">d</span>
<span class="kn">from</span> <span class="nn">numba.decorators</span> <span class="kn">import</span> <span class="n">jit</span> <span class="k">as</span> <span class="n">jit</span>
<span class="k">def</span> <span class="nf">sum2d</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="n">csum2d</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">ret_type</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">arg_types</span><span class="o">=</span><span class="p">[</span><span class="n">d</span><span class="p">[:,:]])(</span><span class="n">sum2d</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">random</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">sum2d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="k">print</span> <span class="s2">&quot;Result from python is </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> (msec)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">duration</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">csum2d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="n">duration2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="k">print</span> <span class="s2">&quot;Result from compiled is </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> (msec)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">duration2</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&quot;Speed up is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="n">duration2</span><span class="p">)</span>
</pre></div>


<p>Como se puede ver, en la línea 12 se aplica la función <code>jit</code> (que también funciona como decorador, como ya veremos) al pequeño programa que hemos escrito para sumar los elementos de una matriz. El argumento <code>arg_types</code> indica que a la función sum2d se le va a pasar un array de NumPy de dos dimensiones. Esto viene a ser como una declaración de tipos.</p>
<p>Comprobemos los resultados:</p>
<div class="highlight"><pre><span></span>$ python -O sum.py
Result from python is -72.8742506632 in <span class="m">4</span>.33301925659 <span class="o">(</span>msec<span class="o">)</span>
Result from compiled is -72.8742506632 in <span class="m">0</span>.028133392334 <span class="o">(</span>msec<span class="o">)</span>
Speed up is <span class="m">154</span>.016949153
</pre></div>


<p>Conseguimos <strong>un aumento de 150x</strong>, solamente añadiendo una línea.</p>
<p>Probemos otro de los ejemplos, <a href="https://github.com/numba/numba/blob/master/examples/example.py">https://github.com/numba/numba/blob/master/examples/example.py</a>. En este caso se trata de comparar numba con una función de SciPy, y podemos ver cómo se utiliza el decorador:</p>
<div class="highlight"><pre><span></span><span class="nd">@jit</span><span class="p">(</span><span class="n">arg_types</span><span class="o">=</span><span class="p">[</span><span class="n">int32</span><span class="p">[:,:],</span> <span class="n">int32</span><span class="p">[:,:]],</span> <span class="n">ret_type</span><span class="o">=</span><span class="n">int32</span><span class="p">[:,:])</span>
<span class="k">def</span> <span class="nf">filter2d</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filt</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Mf</span><span class="p">,</span> <span class="n">Nf</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Mf2</span> <span class="o">=</span> <span class="n">Mf</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">Nf2</span> <span class="o">=</span> <span class="n">Nf</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Mf2</span><span class="p">,</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Mf2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nf2</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">Nf2</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Mf</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nf</span><span class="p">):</span>
                    <span class="n">num</span> <span class="o">+=</span> <span class="p">(</span><span class="n">filt</span><span class="p">[</span><span class="n">Mf</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">,</span> <span class="n">Nf</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">Mf2</span><span class="o">+</span><span class="n">ii</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="n">Nf2</span><span class="o">+</span><span class="n">jj</span><span class="p">])</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>


<p>Ahora estamos indicando que la función requiere dos arrays de enteros. Nótese que tenemos cuatro (4) bucles anidados. Si ahora probamos el ejemplo:</p>
<div class="highlight"><pre><span></span>$ python -O example.py
Time <span class="k">for</span> LLVM <span class="nv">code</span> <span class="o">=</span> <span class="m">0</span>.028516
Time <span class="k">for</span> <span class="nv">convolve</span> <span class="o">=</span> <span class="m">0</span>.041848
</pre></div>


<p>Aquí hemos conseguido una ganancia de <strong>1.47x</strong>. Nótese que la versión de SciPy está <strong>escrita en C</strong>.</p>
<p>Por último, vamos a ver uno de los experimentos llevados a cabo por Alex Wiltschko creado a raíz de <a href="http://jakevdp.github.com/blog/2012/08/08/memoryview-benchmarks">un artículo sobre Cython</a>. Podemos ver los resultados del experimento en el <a href="http://nbviewer.ipython.org/">IPython Notebook Viewer</a>, una web que utiliza la nueva interfaz web de IPython en la que podemos compartir notebooks.</p>
<p>El notebook del experimento está en <a href="http://nbviewer.ipython.org/3362653">http://nbviewer.ipython.org/3362653</a>, y aunque según los comentarios hay resultados dispares, en el ordenador de Wiltschko la versión con numba fue <strong>2 veces más rápida</strong> que la mejr versión de Cython. Si ahora contamos el número de líneas:</p>
<ul>
<li>Python: 17 líneas.</li>
<li>Cython + memviews (sin slicing): 39 líneas.</li>
<li>numba: 13 líneas.</li>
</ul>
<p>Aun considerando que las velocidades sean del mismo orden, es una mejora <strong>espectacular</strong>.</p>
<h2>Comentarios finales</h2>
<p>Estos resultados son bastante impresionantes, pero como hemos dicho más arriba la biblioteca está todavía en pruebas y <em>aún no tiene documentación</em>. Por ejemplo, <em>dentro</em> de las funciones que compilemos con <code>jit</code> <a href="https://github.com/numba/numba/issues/22#issuecomment-7832739">no funcionan la mayoría de las funciones de NumPy</a>, como <code>array.zeros</code>.</p>
<p>Sin embargo, numba es un notable paso hacia adelante y, si no se queda estancada, puede que abra un nuevo camino lleno de posibilidades en la popularización de Python en entornos científicos.</p>
<p>Nosotros estamos muy entusiasmados con numba, ¿y tú? 🙂</p>
        </div>

        <div class="meta">
            <div class="tags">
                    <a href="http://pybonacci.github.io/tag/cython.html" class="tag">cython</a>
                    <a href="http://pybonacci.github.io/tag/numba.html" class="tag">numba</a>
                    <a href="http://pybonacci.github.io/tag/python.html" class="tag">python</a>
                    <a href="http://pybonacci.github.io/tag/rendimiento.html" class="tag">rendimiento</a>
            </div>
        </div>


    </article>
<div id="commento"></div>
</div>

<style type="text/css">
{
    max-width: 700px;
}

.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
    max-width: 580px;
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}

table.dataframe th, td {
    padding: 4px;
    text-align: left;
}

pre code {
    background-color: inherit;
}</style>

        </div>

        <footer class="disclaimer">
          <div class="container-fluid">
            <p>
              © 2012-2017 Pybonacci, licencia <a href="https://github.com/Pybonacci/pybonacci.github.io/blob/sources/LICENSE.md"> CC BY-SA 4.0 + MIT</a>
              salvo otra indicación.
              <p>Contenido generado con <a href= "http://docs.getpelican.com/">Pelican</a>.</p>
            </p>
          </div>
        </footer>

    </body>
</html>